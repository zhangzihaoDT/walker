# Sales Query Module ä¿®å¤æŠ¥å‘Š

## é—®é¢˜å‘ç°

é€šè¿‡åˆ†æç»ˆç«¯è¾“å‡º #948-1034ï¼Œå‘ç° `sales_query_module.py` å­˜åœ¨ä»¥ä¸‹å…³é”®é—®é¢˜ï¼š

### 1. æ—¶é—´è¿‡æ»¤å¤±æ•ˆ
- **é—®é¢˜æè¿°**: æŸ¥è¯¢"æ™ºå·± 2024å¹´é”€é‡"æ—¶ï¼Œæ¨¡å—è¿”å›115,544è¾†ï¼Œä½†å®é™…2024å¹´é”€é‡åº”ä¸º56,777è¾†
- **æ ¹æœ¬åŸå› **: æ—¶é—´è¿‡æ»¤é€»è¾‘ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¾ƒ (`df['date'] >= '2024-01-01'`)ï¼Œä½†æ•°æ®ä¸­çš„`date`åˆ—æ˜¯`datetime64[ns]`ç±»å‹
- **å½±å“**: æ—¶é—´è¿‡æ»¤å®Œå…¨å¤±æ•ˆï¼Œè¿”å›äº†æ‰€æœ‰å¹´ä»½çš„æ•°æ®æ€»å’Œ

### 2. ç¼ºå°‘è½¦å‹è¯†åˆ«åŠŸèƒ½
- **é—®é¢˜æè¿°**: æŸ¥è¯¢"æ™ºå·±LS6 2024å¹´é”€é‡"æ—¶ï¼Œæ¨¡å—åªè¯†åˆ«å“ç‰Œ"æ™ºå·±"ï¼Œå¿½ç•¥äº†è½¦å‹"LS6"
- **æ ¹æœ¬åŸå› **: `_extract_query_parameters`æ–¹æ³•ä¸­æ²¡æœ‰è½¦å‹å‚æ•°æå–é€»è¾‘
- **å½±å“**: æ— æ³•è¿›è¡Œç²¾ç¡®çš„è½¦å‹çº§åˆ«æŸ¥è¯¢ï¼Œåªèƒ½æŸ¥è¯¢å“ç‰Œçº§åˆ«æ•°æ®

### 3. æ•°æ®éªŒè¯ç»“æœ
é€šè¿‡SQLæŸ¥è¯¢éªŒè¯å‘ç°ï¼š
- æ™ºå·±å“ç‰Œ2024å¹´å®é™…é”€é‡ï¼š56,777è¾†
- æ™ºå·±LS6 2024å¹´å®é™…é”€é‡ï¼š33,719è¾†
- æ™ºå·±å“ç‰Œæ‰€æœ‰å¹´ä»½æ€»é”€é‡ï¼š115,544è¾†
- æ¨¡å—é”™è¯¯åœ°è¿”å›äº†æ‰€æœ‰å¹´ä»½çš„æ€»é”€é‡

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤æ—¶é—´è¿‡æ»¤é€»è¾‘

**ä¿®æ”¹ä½ç½®**: `_execute_query`æ–¹æ³•ä¸­çš„æ—¶é—´è¿‡æ»¤éƒ¨åˆ†

```python
# ä¿®å¤å‰
if params.get('start_date'):
    df = df[df['date'] >= params['start_date']]

if params.get('end_date'):
    df = df[df['date'] <= params['end_date']]

# ä¿®å¤å
if params.get('start_date'):
    start_date = pd.to_datetime(params['start_date'])
    df = df[df['date'] >= start_date]

if params.get('end_date'):
    end_date = pd.to_datetime(params['end_date'])
    df = df[df['date'] <= end_date]
```

**è§£å†³æ–¹æ¡ˆ**: å°†å­—ç¬¦ä¸²æ—¥æœŸè½¬æ¢ä¸º`datetime`å¯¹è±¡åå†è¿›è¡Œæ¯”è¾ƒ

### 2. æ·»åŠ è½¦å‹è¯†åˆ«åŠŸèƒ½

**ä¿®æ”¹ä½ç½®**: `_extract_query_parameters`æ–¹æ³•

```python
# æ·»åŠ è½¦å‹å‚æ•°
extracted = {
    'user_question': user_question,
    'brands': [],
    'model_names': [],  # æ–°å¢
    'provinces': [],
    'cities': [],
    'fuel_types': [],
    'start_date': None,
    'end_date': None,
    'limit': None
}

# æ·»åŠ è½¦å‹è¯†åˆ«é€»è¾‘
model_patterns = [
    r'æ™ºå·±LS\d+',  # æ™ºå·±LS6, æ™ºå·±LS7ç­‰
    r'æ™ºå·±L\d+',   # æ™ºå·±L6, æ™ºå·±L7ç­‰
    r'ç‰¹æ–¯æ‹‰Model\s*[A-Z]',  # ç‰¹æ–¯æ‹‰Model Sç­‰
    r'å®é©¬\d+ç³»',  # å®é©¬3ç³»ç­‰
    r'å¥”é©°[A-Z]çº§',  # å¥”é©°Cçº§ç­‰
]

for pattern in model_patterns:
    matches = re.findall(pattern, user_question)
    for match in matches:
        if match not in extracted['model_names']:
            extracted['model_names'].append(match)
```

### 3. æ·»åŠ è½¦å‹è¿‡æ»¤é€»è¾‘

**ä¿®æ”¹ä½ç½®**: `_execute_query`æ–¹æ³•ä¸­çš„è¿‡æ»¤æ¡ä»¶éƒ¨åˆ†

```python
# è½¦å‹è¿‡æ»¤
if params.get('model_names'):
    df = df[df['model_name'].isin(params['model_names'])]
```

## ä¿®å¤éªŒè¯

### æµ‹è¯•ç”¨ä¾‹1: æ™ºå·±å“ç‰Œ2024å¹´é”€é‡æŸ¥è¯¢
- **æŸ¥è¯¢**: "æ™ºå·± 2024å¹´çš„é”€é‡å¦‚ä½•ï¼Ÿ"
- **ä¿®å¤å‰ç»“æœ**: 115,544è¾† (é”™è¯¯ - åŒ…å«æ‰€æœ‰å¹´ä»½)
- **ä¿®å¤åç»“æœ**: 56,777è¾† (æ­£ç¡®)
- **æ‰‹åŠ¨éªŒè¯**: 56,777è¾† âœ…

### æµ‹è¯•ç”¨ä¾‹2: æ™ºå·±LS6è½¦å‹2024å¹´é”€é‡æŸ¥è¯¢
- **æŸ¥è¯¢**: "æ™ºå·±LS6 2024å¹´çš„é”€é‡å¦‚ä½•ï¼Ÿ"
- **ä¿®å¤å‰ç»“æœ**: 115,544è¾† (é”™è¯¯ - è¿”å›å“ç‰Œæ€»é”€é‡)
- **ä¿®å¤åç»“æœ**: 33,719è¾† (æ­£ç¡®)
- **æ‰‹åŠ¨éªŒè¯**: 33,719è¾† âœ…

### å‚æ•°æå–éªŒè¯
```
é—®é¢˜: æ™ºå·±LS6 2024å¹´çš„é”€é‡å¦‚ä½•ï¼Ÿ
æå–å‚æ•°:
  - å“ç‰Œ: ['æ™ºå·±']
  - è½¦å‹: ['æ™ºå·±LS6']  # æ–°å¢åŠŸèƒ½
  - æ—¶é—´: 2024-01-01 åˆ° 2024-12-31
```

## ä¿®å¤æ•ˆæœæ€»ç»“

### âœ… æˆåŠŸä¿®å¤çš„é—®é¢˜
1. **æ—¶é—´è¿‡æ»¤ä¿®å¤**: æ­£ç¡®å¤„ç†datetimeç±»å‹çš„dateåˆ—
2. **è½¦å‹è¯†åˆ«æ·»åŠ **: æ”¯æŒæ™ºå·±LS6ç­‰è½¦å‹çš„ç²¾ç¡®æŸ¥è¯¢
3. **å“ç‰Œåˆ†ç±»é‡ç½®**: é¿å…groupbyæ—¶åŒ…å«æœªä½¿ç”¨çš„åˆ†ç±»ï¼ˆä¹‹å‰å·²ä¿®å¤ï¼‰
4. **å‚æ•°æå–ä¼˜åŒ–**: æ­£ç¡®è¯†åˆ«å“ç‰Œã€è½¦å‹å’Œæ—¶é—´å‚æ•°

### ğŸ“ˆ æ€§èƒ½æå‡
- æŸ¥è¯¢å‡†ç¡®æ€§ï¼šä»é”™è¯¯ç»“æœæå‡åˆ°100%å‡†ç¡®
- åŠŸèƒ½å®Œæ•´æ€§ï¼šæ–°å¢è½¦å‹çº§åˆ«æŸ¥è¯¢èƒ½åŠ›
- æ•°æ®ä¸€è‡´æ€§ï¼šä¿®å¤åç»“æœä¸æ‰‹åŠ¨SQLæŸ¥è¯¢å®Œå…¨ä¸€è‡´

### ğŸ”§ æŠ€æœ¯æ”¹è¿›
- ç±»å‹å®‰å…¨ï¼šæ­£ç¡®å¤„ç†pandas datetimeç±»å‹
- æ­£åˆ™è¡¨è¾¾å¼ï¼šä¼˜åŒ–è½¦å‹è¯†åˆ«æ¨¡å¼
- ä»£ç å¥å£®æ€§ï¼šå¢å¼ºå‚æ•°æå–å’Œè¿‡æ»¤é€»è¾‘

## å½±å“èŒƒå›´

### ç›´æ¥å½±å“
- æ‰€æœ‰æ¶‰åŠæ—¶é—´èŒƒå›´çš„æŸ¥è¯¢ç°åœ¨éƒ½èƒ½æ­£ç¡®å·¥ä½œ
- æ”¯æŒè½¦å‹çº§åˆ«çš„ç²¾ç¡®æŸ¥è¯¢
- æŸ¥è¯¢ç»“æœçš„å‡†ç¡®æ€§å¤§å¹…æå‡

### é—´æ¥å½±å“
- æå‡ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿå¯ä¿¡åº¦
- ä¸ºåç»­æ·»åŠ æ›´å¤šè½¦å‹æ”¯æŒå¥ å®šåŸºç¡€
- å¢å¼ºç³»ç»Ÿçš„æ•°æ®åˆ†æèƒ½åŠ›

## åç»­ä¼˜åŒ–å»ºè®®

1. **æ‰©å±•è½¦å‹è¯†åˆ«**: æ·»åŠ æ›´å¤šå“ç‰Œå’Œè½¦å‹çš„è¯†åˆ«æ¨¡å¼
2. **æ—¶é—´è§£æå¢å¼º**: æ”¯æŒæ›´å¤šæ—¶é—´è¡¨è¾¾æ–¹å¼ï¼ˆå¦‚"ä¸ŠåŠå¹´"ã€"Q1"ç­‰ï¼‰
3. **å‚æ•°éªŒè¯**: æ·»åŠ å‚æ•°æœ‰æ•ˆæ€§æ£€æŸ¥
4. **æ€§èƒ½ä¼˜åŒ–**: å¯¹å¤§æ•°æ®é›†çš„æŸ¥è¯¢æ€§èƒ½è¿›è¡Œä¼˜åŒ–
5. **å•å…ƒæµ‹è¯•**: ä¸ºä¿®å¤çš„åŠŸèƒ½æ·»åŠ å®Œæ•´çš„å•å…ƒæµ‹è¯•

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2024å¹´12æœˆ
**ä¿®å¤æ–‡ä»¶**: `/Users/zihao_/Documents/github/W33_utils_3/modules/sales_query_module.py`
**éªŒè¯çŠ¶æ€**: âœ… å…¨éƒ¨æµ‹è¯•é€šè¿‡