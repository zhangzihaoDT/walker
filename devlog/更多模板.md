## 销量查询模块模板分析报告

### 🔍 问题诊断

经过深入分析 <mcfile name="sales_query_module.py" path="/Users/zihao_/Documents/github/W33_utils_3/modules/sales_query_module.py"></mcfile>，我发现了以下关键问题：

#### 1. **模板数量不足，缺乏品牌+车型组合查询模板**

当前只有 5 个查询模板：

- `brand_sales`：品牌销量查询
- `time_trend`：时间趋势查询
- `region_sales`：地区销量查询
- `fuel_type_analysis`：燃料类型分析
- `general_sales`：综合销量查询

**缺失的关键模板：**

- ❌ 品牌+车型组合查询模板
- ❌ 车型销量专门查询模板
- ❌ 多维度组合查询模板

#### 2. **模板选择逻辑存在缺陷**

在 <mcsymbol name="_select_template" filename="sales_query_module.py" path="/Users/zihao_/Documents/github/W33_utils_3/modules/sales_query_module.py" startline="667" type="function"></mcsymbol> 方法中：

```python
# 当前逻辑只考虑brands参数，忽略了model_names
if has_valid_values(params.get('brands')):
    return self.query_templates['brand_sales']
```

**问题：** 当用户查询"智己 LS6 2024 年销量"时，虽然提取到了`brands=['智己']`和`model_names=['智己LS6']`，但模板选择逻辑只看到 brands 参数，选择了"品牌销量查询"模板，**完全忽略了车型信息**。

#### 3. **现有模板不支持车型维度**

所有现有模板的 SQL 都没有包含`model_name`字段：

```sql
-- 品牌销量模板（缺少model_name）
SELECT
    brand,  -- ❌ 只有品牌，没有车型
    SUM(sales_volume) as total_sales
FROM data
WHERE brand IN ({{ brands }})
GROUP BY brand  -- ❌ 只按品牌分组
```

#### 4. **查询执行逻辑虽然支持车型过滤，但结果不体现**

在 <mcsymbol name="_execute_query" filename="sales_query_module.py" path="/Users/zihao_/Documents/github/W33_utils_3/modules/sales_query_module.py" startline="692" type="function"></mcsymbol> 中：

```python
# ✅ 车型过滤逻辑存在且正确
if params.get('model_names'):
    valid_model_names = [m for m in params['model_names'] if m is not None]
    if valid_model_names:
        df = df[df['model_name'].isin(valid_model_names)]

# ❌ 但聚合时只按brand分组，车型信息丢失
result = df.groupby('brand').agg({
    'sales_volume': ['sum', 'count', 'mean']
})
```

### 💡 解决方案

#### 1. **新增专门的车型查询模板**

需要添加以下模板：

```python
"model_sales": {
    "name": "车型销量查询",
    "description": "查询指定车型的销量数据",
    "template": """
    SELECT
        brand,
        model_name,
        SUM(sales_volume) as total_sales,
        COUNT(*) as record_count,
        AVG(sales_volume) as avg_sales
    FROM data
    WHERE 1=1
    {% if brands %}
        AND brand IN ({{ brands | map('tojsonfilter') | join(', ') }})
    {% endif %}
    {% if model_names %}
        AND model_name IN ({{ model_names | map('tojsonfilter') | join(', ') }})
    {% endif %}
    GROUP BY brand, model_name
    ORDER BY total_sales DESC
    """
}
```

#### 2. **优化模板选择逻辑**

```python
def _select_template(self, params: Dict[str, Any]) -> Dict[str, Any]:
    # 优先级：车型 > 燃料类型 > 地区 > 品牌 > 时间 > 通用
    if has_valid_values(params.get('model_names')):
        return self.query_templates['model_sales']  # 新增
    elif has_valid_values(params.get('fuel_types')):
        return self.query_templates['fuel_type_analysis']
    # ... 其他逻辑
```

#### 3. **增强现有模板的多维度支持**

为现有模板添加车型维度支持，例如在品牌销量模板中：

```sql
SELECT
    brand,
    {% if model_names %}model_name,{% endif %}
    SUM(sales_volume) as total_sales
FROM data
WHERE 1=1
{% if model_names %}
    AND model_name IN ({{ model_names | map('tojsonfilter') | join(', ') }})
{% endif %}
GROUP BY brand{% if model_names %}, model_name{% endif %}
```

### 📊 影响评估

**当前问题导致的用户体验问题：**

- 用户查询"智己 LS6 销量"时，返回的是整个智己品牌的销量，而不是 LS6 车型的销量
- 无法进行精确的车型级别分析
- 多维度查询能力受限

**修复后的改进：**

- ✅ 支持精确的车型级别查询
- ✅ 支持品牌+车型组合分析
- ✅ 提供更准确的查询结果
- ✅ 增强多维度查询能力

### 🎯 建议优先级

1. **高优先级**：新增车型销量查询模板
2. **中优先级**：优化模板选择逻辑
3. **低优先级**：增强现有模板的多维度支持

这个分析解释了为什么在 Terminal#700-761 的输出中，虽然 GLM 成功提取了车型参数，但最终查询结果中车型信息"丢失"了——因为选择的模板和聚合逻辑都没有考虑车型维度。
