# Graph Builder å’Œ Router ä¼˜åŒ–æ€»ç»“

## é—®é¢˜åˆ†æ

æ ¹æ®ç»ˆç«¯è¾“å‡ºåˆ†æï¼Œå‘ç°ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š

1. **æ„å›¾è¯†åˆ«é”™è¯¯**ï¼šæ‰€æœ‰ `query_only` ç±»å‹çš„é—®é¢˜éƒ½è¢«é”™è¯¯è¯†åˆ«ä¸º `data_analysis`
2. **è·¯ç”±é€»è¾‘è¿‡æ—¶**ï¼š`router.py` ä¸­ä»åœ¨è°ƒç”¨å·²åˆ é™¤çš„æ–¹æ³• `should_analyze_data` å’Œ `data_analysis_node`
3. **æç¤ºè¯é—®é¢˜**ï¼šæ„å›¾è¯†åˆ«æç¤ºè¯ä¸­çš„ç¤ºä¾‹ä½¿ç”¨äº†é”™è¯¯çš„æ„å›¾ç±»å‹
4. **å“åº”ç”Ÿæˆä¸å®Œæ•´**ï¼š`response_generation_node` æ²¡æœ‰å¤„ç† `query_only` ç±»å‹çš„å“åº”

## ä¼˜åŒ–æªæ–½

### 1. ä¿®å¤æ„å›¾è¯†åˆ«æç¤ºè¯ (`llm/prompts.py`)

**é—®é¢˜**ï¼šæç¤ºè¯ç¤ºä¾‹ä½¿ç”¨ `data_analysis` è€Œä¸æ˜¯ `query_only`ï¼Œå¯¼è‡´æ¨¡å‹åå‘é”™è¯¯åˆ†ç±»

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ äº†ä¸‰ä¸ªå®Œæ•´çš„ç¤ºä¾‹ï¼Œåˆ†åˆ«å¯¹åº” `query_only`ã€`data_analysis` å’Œ `general_chat`
- æ˜ç¡®æ ‡æ³¨æ¯ç§æ„å›¾ç±»å‹çš„å¤„ç†æ–¹å¼
- ä¼˜åŒ–åˆ¤æ–­è§„åˆ™æè¿°ï¼Œä½¿å…¶æ›´åŠ æ¸…æ™°

```python
# ä¿®å¤å‰ï¼šåªæœ‰ä¸€ä¸ª data_analysis ç¤ºä¾‹
{
    "intent": "data_analysis",
    "confidence": 0.9,
    "reason": "ç”¨æˆ·è¯¢é—®æ•°æ®ç›¸å…³ä¿¡æ¯",
    "need_data_analysis": true
}

# ä¿®å¤åï¼šä¸‰ä¸ªå®Œæ•´ç¤ºä¾‹
ç¤ºä¾‹1 - ç›´æ¥æŸ¥è¯¢ç±»ï¼š
{
    "intent": "query_only",
    "confidence": 0.9,
    "reason": "ç”¨æˆ·ä½¿ç”¨æŸ¥è¯¢å…³é”®è¯è¿›è¡Œç²¾ç¡®æŸ¥è¯¢",
    "need_data_analysis": false
}
```

### 2. æ›´æ–°è·¯ç”±é€»è¾‘ (`core/router.py`)

**é—®é¢˜**ï¼šè°ƒç”¨å·²åˆ é™¤çš„æ–¹æ³•ï¼Œå¯¼è‡´è·¯ç”±å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å°† `should_analyze_data` æ›¿æ¢ä¸º `should_use_walker`
- å°† `data_analysis_node` æ›¿æ¢ä¸ºå®Œæ•´çš„å¤„ç†æµç¨‹
- æ›´æ–°å‘åå…¼å®¹æ–¹æ³•

```python
# ä¿®å¤å‰
next_step = self.graph_builder.should_analyze_data(state)
if next_step == "data_analysis":
    state = self.graph_builder.data_analysis_node(state)

# ä¿®å¤å
next_step = self.graph_builder.should_use_walker(state)
if next_step == "walker_strategy":
    state = self.graph_builder.walker_strategy_node(state)
    state = self.graph_builder.execution_planning_node(state)
    state = self.graph_builder.module_execution_node(state)
elif next_step == "sql_agent":
    state = self.graph_builder.sql_agent_node(state)
```

### 3. å®Œå–„å“åº”ç”Ÿæˆ (`core/graph_builder.py`)

**é—®é¢˜**ï¼š`response_generation_node` æ²¡æœ‰å¤„ç† `query_only` ç±»å‹

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  `query_only` ç±»å‹çš„å“åº”å¤„ç†é€»è¾‘
- ä¿®å¤ `sql_agent_node` è®¾ç½®æ­£ç¡®çš„çŠ¶æ€å­—æ®µ
- åœ¨ `WorkflowState` ä¸­æ·»åŠ  `sql_result` å­—æ®µ

```python
# æ·»åŠ  query_only å¤„ç†
elif intent == "query_only":
    sql_result = state.get("sql_result", "")
    if sql_result:
        response = f"æŸ¥è¯¢ç»“æœï¼š\n{sql_result}"
    else:
        response = "æŠ±æ­‰ï¼ŒæŸ¥è¯¢æœªè¿”å›ç»“æœã€‚è¯·æ£€æŸ¥æ‚¨çš„æŸ¥è¯¢æ¡ä»¶ã€‚"
```

### 4. ä¿®å¤çŠ¶æ€ç®¡ç†

**é—®é¢˜**ï¼šSQL Agent è®¾ç½®é”™è¯¯çš„çŠ¶æ€å­—æ®µ

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å°† `analysis_result` æ”¹ä¸º `sql_result`
- åœ¨ `WorkflowState` ç±»å‹å®šä¹‰ä¸­æ·»åŠ  `sql_result` å­—æ®µ

## æµ‹è¯•éªŒè¯

### 1. æ„å›¾è¯†åˆ«æµ‹è¯•

è¿è¡Œ `test/test_intent_parser.py`ï¼š
- âœ… "æŸ¥è¯¢ç”¨æˆ·æ•°æ®" â†’ `query_only` (ä¹‹å‰é”™è¯¯è¯†åˆ«ä¸º `data_analysis`)
- âœ… "åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®" â†’ `data_analysis`
- âœ… "ä½ å¥½ï¼Œè¯·é—®å¯ä»¥å¸®æˆ‘ä»€ä¹ˆï¼Ÿ" â†’ `general_chat`

### 2. ç®€åŒ–æ¶æ„æµ‹è¯•

è¿è¡Œ `test/test_simplified_intent.py`ï¼š
- âœ… 7/7 æµ‹è¯•é€šè¿‡
- âœ… è·¯ç”±å†³ç­–æ­£ç¡®ï¼š
  - `query_only` â†’ `sql_agent`
  - `data_analysis` â†’ `walker_strategy`
  - `general_chat` â†’ `response_generation`

### 3. è·¯ç”±å™¨é›†æˆæµ‹è¯•

è¿è¡Œ `test/test_router_integration.py`ï¼š
- âœ… query_only è·¯ç”±ï¼šæ­£ç¡®è°ƒç”¨ SQL Agent
- âœ… data_analysis è·¯ç”±ï¼šæ­£ç¡®æ‰§è¡Œ Walker ç­–ç•¥å’Œæ•°æ®åˆ†æ
- âœ… general_chat è·¯ç”±ï¼šæ­£ç¡®è·³è¿‡æ•°æ®åˆ†æï¼Œç›´æ¥ç”Ÿæˆå“åº”

## ä¼˜åŒ–æˆæœ

### 1. æ„å›¾è¯†åˆ«å‡†ç¡®æ€§æå‡
- ä¿®å¤äº† `query_only` ç±»å‹è¢«é”™è¯¯è¯†åˆ«çš„é—®é¢˜
- æç¤ºè¯æ›´åŠ æ¸…æ™°ï¼Œå‡å°‘äº†æ¨¡å‹æ··æ·†
- ä¸‰ç§æ„å›¾ç±»å‹çš„åŒºåˆ†æ›´åŠ æ˜ç¡®

### 2. è·¯ç”±é€»è¾‘å®Œå–„
- ç§»é™¤äº†è¿‡æ—¶çš„æ–¹æ³•è°ƒç”¨
- å®ç°äº†å®Œæ•´çš„è·¯ç”±æµç¨‹
- æ”¯æŒä¸‰ç§ä¸åŒçš„å¤„ç†ç­–ç•¥

### 3. å“åº”ç”Ÿæˆå®Œæ•´
- æ”¯æŒæ‰€æœ‰ä¸‰ç§æ„å›¾ç±»å‹çš„å“åº”ç”Ÿæˆ
- SQL æŸ¥è¯¢ç»“æœæ­£ç¡®å±•ç¤º
- é”™è¯¯å¤„ç†æ›´åŠ å¥å£®

### 4. ä»£ç æ¶æ„ä¼˜åŒ–
- ç®€åŒ–äº†æ„å›¾ç±»å‹ï¼Œç§»é™¤äº†é‡å¤çš„ `data_query`
- ç»Ÿä¸€äº†çŠ¶æ€ç®¡ç†
- æé«˜äº†ä»£ç å¯ç»´æŠ¤æ€§

## æ–‡ä»¶å˜æ›´æ¸…å•

1. **`llm/prompts.py`**ï¼šä¿®å¤æ„å›¾è¯†åˆ«æç¤ºè¯
2. **`core/router.py`**ï¼šæ›´æ–°è·¯ç”±é€»è¾‘å’Œå‘åå…¼å®¹æ–¹æ³•
3. **`core/graph_builder.py`**ï¼šå®Œå–„å“åº”ç”Ÿæˆå’ŒçŠ¶æ€ç®¡ç†
4. **`test/test_router_integration.py`**ï¼šæ–°å¢è·¯ç”±å™¨é›†æˆæµ‹è¯•

## åç»­å»ºè®®

1. **SQL Agent å®ç°**ï¼šå½“å‰ SQL Agent ä½¿ç”¨æ¨¡æ‹Ÿå®ç°ï¼Œå»ºè®®å®Œå–„çœŸå®çš„ SQL æŸ¥è¯¢åŠŸèƒ½
2. **é”™è¯¯å¤„ç†**ï¼šè¿›ä¸€æ­¥å®Œå–„å„ä¸ªèŠ‚ç‚¹çš„é”™è¯¯å¤„ç†é€»è¾‘
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šè€ƒè™‘ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘é‡å¤çš„ API è°ƒç”¨
4. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ æ„å›¾è¯†åˆ«å‡†ç¡®ç‡å’Œè·¯ç”±æˆåŠŸç‡çš„ç›‘æ§

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡ä¼˜åŒ–ï¼ŒæˆåŠŸè§£å†³äº†æ„å›¾è¯†åˆ«é”™è¯¯å’Œè·¯ç”±å¤±è´¥çš„é—®é¢˜ï¼Œå®ç°äº†ï¼š
- ğŸ¯ æ„å›¾è¯†åˆ«å‡†ç¡®ç‡ 100%ï¼ˆæµ‹è¯•ç”¨ä¾‹ï¼‰
- ğŸš¦ è·¯ç”±å†³ç­–æ­£ç¡®ç‡ 100%ï¼ˆæµ‹è¯•ç”¨ä¾‹ï¼‰
- ğŸ“ å“åº”ç”Ÿæˆå®Œæ•´æ€§ 100%ï¼ˆæ”¯æŒæ‰€æœ‰æ„å›¾ç±»å‹ï¼‰
- ğŸ”§ ä»£ç æ¶æ„ç®€åŒ–å’Œä¼˜åŒ–

ç³»ç»Ÿç°åœ¨èƒ½å¤Ÿæ­£ç¡®è¯†åˆ«ç”¨æˆ·æ„å›¾ï¼Œå¹¶æ ¹æ®ä¸åŒçš„æ„å›¾ç±»å‹é€‰æ‹©åˆé€‚çš„å¤„ç†ç­–ç•¥ï¼Œä¸ºç”¨æˆ·æä¾›å‡†ç¡®çš„å“åº”ã€‚